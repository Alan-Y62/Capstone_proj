<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta charset="UTF-8">
        <!--Temporary use of Bootstrap for showing certain elements of webpage; will likely need to scrap-->>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
        <!--    
            <link rel="stylesheet" type="text/css" href="css/index.css">    
        -->

        <title>Upload Repair Images</title>
    </head>

    <body>
        <div class="container">
            <h1 class="mt-5 mb-5 text-center text-primary"><b>Repair Request Image Upload</b></h1>

            <div class="card">
                <div class="card-header text-center font-weight-bold">Drag & drop file(s) inside the box below OR press Choose Files</div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-0">&nbsp;</div>
                        <div class="col-md-6">
                            <div id="drag_drop">Drag & Drop File(s) Here</div>
                        </div>

                        <div class="col-md-3">
                            <!--Adds files with button and also updates list showing files selected-->
                            <input type="file" id="select_file" multiple name="file" onchange="javascript:updateList()"/>
                            <input type="submit" id="real-submit" hidden="true">

                            <strong id="imageUploadList">
                                Image files to be uploaded:
                            </strong>

                            <div id="fileList"></div>
                            <button type="button" onclick="" id="custom-button">Confirm Upload</button>
                        </div>
                        
                    </div>
                </div>
            </div>
            <br />
            <div class="progress" id="progress_bar" style="display:none; height:50px;">
                <div class="progress-bar bg-success" id="progress_bar_process" role="progressbar" style="width:0%; height:50px;">0%

                </div>
            </div>
            <div id="uploaded_image" class="row mt-500"></div>
        </div>
    </body>
</html>

<style>
    #drag_drop {
        background-color : #f9f9f9;
        border : #ccc 4px dashed;
        line-height : 250px;
        padding : 12px;
        font-size : 24px;
        text-align : center;
    }

    #custom-button {
        padding: 10px;
        color: white;
        background-color: rgb(0, 153, 255);
        border: 1px solid white;
        border-radius: 5px;
        cursor: pointer;
    }

    #custom-button:hover {
        background-color: rgb(0, 195, 255);
    }
</style>

<script>
    // updates list of added files
    updateList = function() {
        var input = document.getElementById('selected_file');
        var output = document.getElementById('fileList');
        var list = "";
        for (var i = 0; i < input.files.length; ++i) {
            list += '<li>' + input.files.item(i).name + '</li>';
        }
        output.innerHTML = '<ul>'+list+'</ul>';
    }

    function dragNDrop(element) {
        return document.getElementById(element);
    }
   dragNDrop('drag_drop').ondragover = function(event) {
        this.style.borderColor = '#333';
        return false;
    }
   dragNDrop('drag_drop').ondragleave = function(event) {
        this.style.borderColor = '#ccc';
        return false;
    }

    // Drag and drop uploading
   dragNDrop('drag_drop').ondrop = function(event) {
        event.preventDefault(); //prevents default behavior in the browser from interfering with drag and drop

        dragNDrop('progress_bar').style.display = 'none';
        dragNDrop('progress_bar_process').style.width = 0 + '%';
        dragNDrop('uploaded_image').innerHTML = '';

        var form_data  = new FormData();
        var image_number = 1;
        var error = '';
        var drop_files = event.dataTransfer.files;

        for(var count = 0; count < drop_files.length; count++) {
            if(!['image/png', 'image/jpeg'].includes(drop_files[count].type)) {
                error += '<div class="alert alert-danger"><b>'+image_number+'</b> Selected File MUST BE .jpg or .png ONLY!</div>';
            }
            else {
                form_data.append("images[]", drop_files[count]);
                
                var para = document.createElement("LI");
                var text = document.createTextNode(drop_files.item(count).name);
                para.appendChild(text);
                document.getElementById("imageUploadList").appendChild(para);

            }
            image_number++;
        }

        // checks for no errors along with whether any files were dropped and uses AJAX for uploading files
        if(error == '' && drop_files.length > 0) {
           dragNDrop('progress_bar').style.display = 'block'; //makes progress bar visible
            var ajax_request = new XMLHttpRequest();

            ajax_request.open("post", "file_upload.php");
            ajax_request.upload.addEventListener('progress', function(event) {
                var percent_completed = Math.round((event.loaded / event.total) * 100);
               dragNDrop('progress_bar_process').style.width = percent_completed + '%';
               dragNDrop('progress_bar_process').innerHTML = percent_completed + '% completed';
            });

            ajax_request.addEventListener('load', function(event) {
               dragNDrop('uploaded_image').innerHTML = '<div class="alert alert-success">Files Uploaded Successfully</div>';
               dragNDrop('drag_drop').style.borderColor = '#ccc';
            });

            ajax_request.send(form_data);
        }

        // shows error and resets color of drag and drop box
        else {
           dragNDrop('uploaded_image').innerHTML = error;
           dragNDrop('drag_drop').style.borderColor = '#ccc';
        }
    }


    // Redundant confirm upload button code?
    /*
    const realSelectBtn = document.getElementById("real-submit");
    const customBtn = document.getElementById("custom-button");
    customBtn.addEventListener("click", function() {
        realSelectBtn.click();
    });
    */


    // Button uploading code below; really similar to above drag and drop code
    buttonSelectUpload('selected_file').onchange = function(event){
    var form_data = new FormData();
    var image_number = 1;
    var error = '';
    for(var count = 0; count < buttonSelectUpload('selected_file').files.length; count++)   {
        if(!['image/jpeg', 'image/png'].includes(buttonSelectUpload('selected_file').files[count].type)) {
            error += '<div class="alert alert-danger"><b>'+image_number+'</b> Selected File MUST BE .jpg or .png ONLY!</div>';
        }
        else {
            form_data.append("images[]", buttonSelectUpload('selected_file').files[count]);
        }
        image_number++;
    }

    // should probably merge and move this into a new function for 
    //clicking button to confirm upload for both dragNDrop and buttonSelectUpload
    if(error == '') {
        buttonSelectUpload('progress_bar').style.display = 'block';
        var ajax_request = new XMLHttpRequest();
        ajax_request.open("POST", "file_upload.php");
        ajax_request.upload.addEventListener('progress', function(event){
            var percent_completed = Math.round((event.loaded / event.total) * 100);
            buttonSelectUpload('progress_bar_process').style.width = percent_completed + '%';
            buttonSelectUpload('progress_bar_process').innerHTML = percent_completed + '% completed';
        });
        ajax_request.addEventListener('load', function(event){
            buttonSelectUpload('uploaded_image').innerHTML = '<div class="alert alert-success">Files Uploaded Successfully</div>';
            buttonSelectUpload('selected_file').value = '';
        });
        ajax_request.send(form_data);
    }

    else {
        buttonSelectUpload('uploaded_image').innerHTML = error;
        buttonSelectUpload('selected_file').value = '';
    }
};
</script>